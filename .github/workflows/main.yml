name: Deploy Pipeline

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script_stop: true
          script: |
            set -euxo pipefail

            echo "Connected as:"
            whoami
            id

            echo "Checking /mnt"
            ls -ld /mnt || true

            echo "Creating directories"
            mkdir -p /mnt/dev/pipeline

            echo "Verifying directory"
            ls -ld /mnt/dev /mnt/dev/pipeline

            cd /mnt/dev/pipeline

            echo "Cleaning old repo"
            rm -rf pipeline

            echo "Cloning repo"
            git clone https://github.com/YOUR_ORG/YOUR_PIPELINE_REPO.git pipeline

            cd pipeline

            echo "Docker info"
            docker --version

            echo "Stopping old container"
            docker stop pipeline || true
            docker rm pipeline || true

            echo "Building image"
            docker build -t pipeline .

            echo "Running container"
            docker run -d \
              --name pipeline \
              -p 1111:80 \
              pipeline
